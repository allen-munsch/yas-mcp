services:
  # OpenAPI MCP Server
  yas-mcp:
    profiles: ["mcp"]
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yas-mcp-server
    ports:
      - "${OPENAPI_MCP_PORT:-3000}:3000"
    volumes:
      # Mount your OpenAPI/Swagger file
      - ./${SWAGGER_FILE_PATH:?SWAGGER_FILE_PATH is required}:/app/config/swagger.yaml:ro
      # Optional: Mount adjustments file
      - ./${ADJUSTMENTS_FILE_PATH:-./adjustments.yaml}:/app/config/adjustments.yaml:ro
    environment:
      # Server configuration
      - OPENAPI_MCP_SERVER_MODE=${SERVER_MODE:-http}
      - OPENAPI_MCP_SERVER_HOST=0.0.0.0
      - OPENAPI_MCP_SERVER_PORT=3000
      
      # Endpoint configuration (the API to call)
      - OPENAPI_MCP_ENDPOINT_BASE_URL=${API_BASE_URL:-http://prism:4010}
      
      # Logging
      - OPENAPI_MCP_LOGGING_LEVEL=${LOG_LEVEL:-info}
      - OPENAPI_MCP_LOGGING_FORMAT=${LOG_FORMAT:-compact}
      
      # File paths
      - OPENAPI_MCP_SWAGGER_FILE=/app/config/swagger.yaml
      - OPENAPI_MCP_ADJUSTMENTS_FILE=/app/config/adjustments.yaml
    command: [
      "--swagger-file", "/app/config/swagger.yaml",
      "--adjustments-file", "/app/config/adjustments.yaml",
      "--endpoint", "${API_BASE_URL:-http://prism:4010}",
      "--mode", "${SERVER_MODE:-http}",
      "--host", "0.0.0.0",
      "--port", "3000"
    ]
    restart: unless-stopped
    networks:
      - yas-mcp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Prism Mock Server (for testing) - simplified command
  prism:
    image: stoplight/prism:5
    container_name: prism-mock
    profiles: ["auth"]
    ports:
      - "${PRISM_PORT:-4010}:4010"
    volumes:
      - ./${SWAGGER_FILE_PATH:?SWAGGER_FILE_PATH is required}:/tmp/openapi.yaml:ro
    command: ["mock", "-h", "0.0.0.0", "/tmp/openapi.yaml"]
    networks:
      - yas-mcp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4010/"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  # Test Container - simplified command
  test-container:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: yas-mcp-tests
    depends_on:
      - yas-mcp
      - prism
    environment:
      # Test configuration
      - MCP_SERVER_URL=http://yas-mcp:3000
      - API_BASE_URL=http://prism:4010
      - SWAGGER_FILE_PATH=${SWAGGER_FILE_PATH}
      
      # Logging for tests
      - RUST_LOG=debug
      - TEST_TIMEOUT=90
      
      # Reuse existing env vars
      - OPENAPI_MCP_PORT=${OPENAPI_MCP_PORT:-3000}
      - PRISM_PORT=${PRISM_PORT:-8080}
    networks:
      - yas-mcp-network
    volumes:
      - ./test-results:/app/test-results
      - .:/app:ro
      - ./scripts/test-integration.sh:/app/scripts/test-integration.sh
    profiles: ["test"]
    command: ["/app/scripts/test-integration.sh"]

  keycloak:
    image: quay.io/keycloak/keycloak:26.4
    profiles: ["auth"]  # Only start with --profile auth
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN:?KEYCLOAK_ADMIN environment variable is required}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?KEYCLOAK_ADMIN_PASSWORD environment variable is required}
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8081
      KC_HTTP_ENABLED: true
    ports:
      - "8081:8080"
    command: start-dev
    networks:
      - yas-mcp-network

networks:
  yas-mcp-network:
    driver: bridge